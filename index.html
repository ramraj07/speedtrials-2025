<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Drinking Water Explorer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet (Map) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Select2 (Search Dropdown) CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

    <!-- Custom Styles -->
    <style>
        /* Base styling for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind's gray-50 */
        }

        /* --- Loader --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(248, 250, 252, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            transition: opacity 0.5s ease-in-out;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #3b82f6); /* Tailwind's blue-500 */
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 9px), #000 0);
            animation: spin 1.2s infinite linear;
        }
        @keyframes spin {
            100% { transform: rotate(1turn); }
        }

        /* --- View Containers --- */
        #map-view, #dashboard-view {
            display: none;
        }

        /* --- Leaflet Map Customization --- */
        #map {
            height: 70vh;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            margin: 1rem;
        }
        .leaflet-popup-content .btn-popup-details {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.75rem;
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
        }
        .leaflet-popup-content .btn-popup-details:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .legend {
            padding: 0.75rem 1rem;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.5rem; /* rounded-lg */
            line-height: 1.5;
        }
        .legend h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #1f2937; /* gray-800 */
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
            border-radius: 50%;
            border: 1px solid #6b7280; /* gray-500 */
        }

        /* --- Select2 Dropdown Customization --- */
        .select2-container--default .select2-selection--single {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            height: 42px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 40px;
            padding-left: 1rem;
            color: #374151; /* gray-700 */
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }
        .select2-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .select2-search--dropdown .select2-search__field {
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db;
        }
        .select2-results__option--highlighted.select2-results__option--selectable {
            background-color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Indicator -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-message" class="text-lg font-semibold text-gray-600">Loading Georgia Water System Data...</p>
    </div>

    <!-- Main Map View -->
    <main id="map-view" class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Georgia Water Quality Explorer</h1>
                <p class="mt-2 text-lg text-gray-500 max-w-3xl mx-auto">Click a system on the map or use the search tools below to find a detailed report.</p>
            </div>

            <!-- Search Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                <div>
                    <label for="zip-search-input" class="block text-sm font-medium text-gray-700 mb-1">1. Go to ZIP Code on Map</label>
                    <div class="flex items-center shadow-sm">
                        <input type="text" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" id="zip-search-input" placeholder="Enter 5-digit ZIP">
                        <button class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" type="button" id="zip-search-btn">Go</button>
                    </div>
                </div>
                <div>
                     <label for="pws-select" class="block text-sm font-medium text-gray-700 mb-1">2. Find System by Name/ID</label>
                     <div class="flex items-center">
                        <select id="pws-select" class="block w-full"></select>
                        <button class="ml-2 p-2.5 border border-gray-300 bg-white text-gray-600 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-sm" type="button" id="reset-map-view-btn" title="Reset Map View">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>
                        </button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-2">
            <div id="map"></div>
        </div>
    </main>

    <!-- Dashboard View -->
    <section id="dashboard-view" class="container mx-auto px-4 py-8">
        <div class="relative">
            <button id="back-to-map" class="absolute top-0 left-0 flex items-center gap-2 px-4 py-2 bg-white text-gray-700 font-semibold border border-gray-300 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                Back to Map
            </button>
            <div id="dashboard-header" class="text-center pt-16 mb-8">
                <h2 id="dashboard-title" class="text-3xl font-bold text-gray-900"></h2>
                <p id="dashboard-subtitle" class="mt-1 text-lg text-gray-500"></p>
            </div>
        </div>

        <!-- Dashboard Content Grid -->
        <div class="space-y-6">
            <!-- Card Wrapper -->
            <div id="gantt-chart-container" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-900 text-center">Violation Timeline</h3>
                <p class="text-center text-gray-500 text-sm mt-1 mb-4">Timeline of health-based and other violations. Scroll or use the date slider to explore.</p>
                <div id="gantt-chart-scroll-wrapper" class="overflow-x-hidden" style="max-height: 70vh; overflow-y: auto;">
                    <div id="gantt-chart"></div>
                </div>
            </div>

            <!-- Card Wrapper -->
            <div id="water-quality-summary-container" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8" style="display: none;">
                 <h3 class="text-xl font-semibold text-gray-900 text-center">Water Quality Summary</h3>
                 <div id="water-quality-summary-loader" class="text-center py-8">
                     <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                     <p class="mt-3 text-gray-500">Fetching water quality analysis...</p>
                 </div>
                 <div id="water-quality-summary-content" class="prose max-w-none prose-p:text-gray-600 prose-strong:text-gray-700 mt-4"></div>
            </div>

            <!-- Card Wrapper for Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Site Visits Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
                    <h3 class="text-xl font-semibold text-gray-900 text-center mb-4">Recent Site Visits</h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left" id="site-visits-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-3">Visit Date</th>
                                    <th class="px-6 py-3">Reason</th>
                                    <th class="px-6 py-3">Agency</th>
                                    <th class="px-6 py-3">Comments</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Facilities Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
                    <h3 class="text-xl font-semibold text-gray-900 text-center mb-4">Water Source Facilities</h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left" id="facilities-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-3">Facility Name</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3">Water Type</th>
                                    <th class="px-6 py-3">Availability</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Core JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Main Application Logic -->
    <script>
    $(document).ready(function() {
        // --- Global State ---
        let DATA_STORE = {};
        let CODES_MAP = new Map();
        let ALL_SYSTEM_OPTIONS = [];
        let GEOCODED_SYSTEMS = [];
        let ZIP_COORDS = {};
        let map = null;
        let activePwsId = null;

        const $loader = $('#loader');
        const $mapView = $('#map-view');
        const $dashboardView = $('#dashboard-view');
        const $zipInput = $('#zip-search-input');
        const $pwsSelect = $('#pws-select');

        // --- Data Loading ---
        // REVERTED: Using original local file paths as requested.
        // NOTE: This will only work if the files are served by a local web server.
        const filesToLoad = [
            "data/SDWA_VIOLATIONS_ENFORCEMENT.csv",
            "data/SDWA_PUB_WATER_SYSTEMS.csv",
            "data/SDWA_GEOGRAPHIC_AREAS.csv",
            "data/SDWA_REF_CODE_VALUES.csv",
            "data/SDWA_SITE_VISITS.csv",
            "data/SDWA_FACILITIES.csv",
            "data/zipCodeToLatLong.csv"
        ];

        let loadedCount = 0;
        const promises = filesToLoad.map(file => new Promise((resolve, reject) => {
            const fileName = file.substring(file.lastIndexOf('/') + 1);
            Papa.parse(file, {
                download: true, header: true, skipEmptyLines: true,
                complete: results => {
                    loadedCount++;
                    $('#loader-message').text(`Loading... (${loadedCount}/${filesToLoad.length}) ${fileName}`);
                    resolve({ name: fileName, data: results.data });
                },
                error: (err, f) => reject(new Error(`Failed to load ${fileName}. Ensure it's accessible via a local server.`))
            });
        }));

        Promise.all(promises).then(files => {
            files.forEach(file => { DATA_STORE[file.name] = file.data; });
            initializeMainView();
            $loader.fadeOut();
            $mapView.fadeIn('fast', () => { if (map) map.invalidateSize(); });
        }).catch(err => {
            $loader.html(`<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto" role="alert"><h4 class="font-bold">Data Loading Failed</h4><p class="mt-2">${err.message}</p><p class="mt-2 text-sm">This is likely due to browser security restrictions. Please see the instructions on running a local web server.</p></div>`);
        });

        // --- View Initialization ---
        function initializeMainView() {
            const systemsData = DATA_STORE['SDWA_PUB_WATER_SYSTEMS.csv'];
            const zipCodeData = DATA_STORE['zipCodeToLatLong.csv'];

            // REVERTED: Using original field names (e.g., 'zip', 'lat') from the user's first code version.
            ZIP_COORDS = zipCodeData.reduce((acc, record) => {
                const zip = record.zip || record.ZIP;
                const lat = record.latitude || record.lat || record.LAT;
                const lon = record.longitude || record.lng || record.lon || record.LNG;
                if (zip && lat && lon) acc[zip] = { lat: parseFloat(lat), lon: parseFloat(lon) };
                return acc;
            }, {});

            const georgiaSystems = systemsData.filter(sys => sys.PWSID && sys.PWSID.startsWith('GA'));

            GEOCODED_SYSTEMS = georgiaSystems.map(system => {
                const zip = system.ZIP_CODE ? system.ZIP_CODE.substring(0, 5) : null;
                const coords = zip ? ZIP_COORDS[zip] : null;
                if (system.PWSID && coords) {
                    return { pwsid: system.PWSID, name: system.PWS_NAME || 'N/A', lat: coords.lat, lon: coords.lon };
                }
                return null;
            }).filter(Boolean);

            CODES_MAP = new Map(DATA_STORE["SDWA_REF_CODE_VALUES.csv"].map(d => [`${d.VALUE_TYPE}|${d.VALUE_CODE}`, d.VALUE_DESCRIPTION]));

            ALL_SYSTEM_OPTIONS = georgiaSystems
                .filter(s => s.PWS_ACTIVITY_CODE === 'A' && s.PWS_NAME)
                .map(s => ({ id: s.PWSID, text: `${s.PWS_NAME} (${s.PWSID})` }))
                .sort((a,b) => a.text.localeCompare(b.text));

            $pwsSelect.select2({
                data: ALL_SYSTEM_OPTIONS,
                placeholder: 'Search by name or PWSID...',
                allowClear: true
            }).on('select2:select', function (e) {
                if (e.params.data.id) {
                    activePwsId = e.params.data.id;
                    showDashboardView(activePwsId);
                }
            });

            generateMapView();
        }

        // --- UI Event Handlers ---
        function showAlert(message) {
            alert(message);
        }

        $('#zip-search-btn').on('click', function() {
            const zip = $zipInput.val().trim();
            if (!/^\d{5}$/.test(zip)) {
                showAlert('Please enter a valid 5-digit ZIP code.');
                return;
            }
            const targetCoords = ZIP_COORDS[zip];
            if (targetCoords && map) {
                map.setView([targetCoords.lat, targetCoords.lon], 11);
            } else {
                showAlert(`Location data for ZIP code ${zip} could not be found.`);
            }
        });

        $('#reset-map-view-btn').on('click', function() {
            $zipInput.val('');
            if (map) {
                map.setView([32.8407, -83.6324], 7);
            }
        });

        $('#back-to-map').on('click', showMapView);

        $(document).on('click', '.view-details-btn', function() {
            const pwsid = $(this).data('pwsid');
            if (pwsid) {
                activePwsId = pwsid;
                showDashboardView(activePwsId);
            }
        });

        // --- View Switching Logic ---
        function showDashboardView(pwsId) {
            $mapView.fadeOut('fast', () => {
                window.scrollTo(0, 0);
                generateDashboard(pwsId);
                $dashboardView.fadeIn('fast', () => {
                    const ganttChart = document.getElementById('gantt-chart');
                    if (ganttChart && ganttChart.data) Plotly.Plots.resize(ganttChart);
                });
            });
        }

        function showMapView() {
            $dashboardView.fadeOut('fast', () => {
                $pwsSelect.val(null).trigger('change');
                activePwsId = null;
                $mapView.fadeIn('fast', () => {
                    if (map) {
                        map.invalidateSize(true);
                        map.setView([32.8407, -83.6324], 7);
                    }
                });
            });
        }

        // --- Map Generation ---
        function generateMapView() {
            const georgiaViolations = DATA_STORE['SDWA_VIOLATIONS_ENFORCEMENT.csv'].filter(v => v.PWSID && v.PWSID.startsWith('GA'));
            const violationCounts = georgiaViolations.reduce((acc, record) => {
                acc[record.PWSID] = (acc[record.PWSID] || 0) + 1;
                return acc;
            }, {});

            const systemsInGeorgia = GEOCODED_SYSTEMS.map(sys => ({ ...sys, violationCount: violationCounts[sys.pwsid] || 0 }));

            if (systemsInGeorgia.length === 0) {
                 $('#map').html('<div class="p-4 text-center text-yellow-700 bg-yellow-50 rounded-lg">No valid Georgia water systems could be mapped.</div>');
                 return;
            }

            const sortedSystems = [...systemsInGeorgia].sort((a, b) => b.violationCount - a.violationCount);
            const redThreshold = sortedSystems.length > 9 ? sortedSystems[9].violationCount : (sortedSystems[0]?.violationCount || 10);
            const finalRedThreshold = Math.max(1, redThreshold);
            const dynamicThresholds = { red: finalRedThreshold, orange: Math.max(1, Math.ceil(finalRedThreshold * 0.5)), yellow: Math.max(1, Math.ceil(finalRedThreshold * 0.2)) };

            if (map) map.remove();
            map = L.map('map').setView([32.8407, -83.6324], 7);
            L.tileLayer('https://{s}.tile.jawg.io/jawg-light/{z}/{x}/{y}{r}.png?access-token={accessToken}', {
                attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                minZoom: 0, maxZoom: 22, subdomains: 'abcd',
                accessToken: 'F3Z1b6a4zQ2u9eQz5rA1YqX2a8c3e8i3B4G8h6c1J2e3F4d5A6g7H8i9'
            }).addTo(map);

            systemsInGeorgia.forEach(system => {
                const marker = L.circleMarker([system.lat, system.lon], {
                    radius: 7, fillColor: getMarkerColor(system.violationCount, dynamicThresholds),
                    color: "#1f2937", weight: 1, opacity: 1, fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `<div class="text-gray-800">
                    <h3 class="font-bold text-base mb-1">${system.name}</h3><hr class="my-1">
                    <p class="text-sm"><strong>PWSID:</strong> ${system.pwsid}</p>
                    <p class="text-sm"><strong style="color:${getMarkerColor(system.violationCount, dynamicThresholds)};">Violations: ${system.violationCount}</strong></p>
                    <button class="btn-popup-details view-details-btn" data-pwsid="${system.pwsid}">View Details</button>
                </div>`;
                marker.bindPopup(popupContent);
            });

            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [0, 1, dynamicThresholds.yellow, dynamicThresholds.orange, dynamicThresholds.red];
                const labels = [
                    '0 Violations',
                    `1 to ${dynamicThresholds.yellow - 1}`,
                    `${dynamicThresholds.yellow} to ${dynamicThresholds.orange - 1}`,
                    `${dynamicThresholds.orange} to ${dynamicThresholds.red - 1}`,
                    `${dynamicThresholds.red}+`
                ];
                div.innerHTML += '<h4>Violation Count</h4>';
                for (let i = 0; i < grades.length; i++) {
                    const color = getMarkerColor(grades[i], dynamicThresholds);
                    if (i > 0 && grades[i] >= (grades[i+1] || Infinity)) continue;
                    div.innerHTML += `<i style="background:${color}"></i> ${labels[i]}<br>`;
                }
                return div;
            };
            legend.addTo(map);
        }

        function getMarkerColor(count, thresholds) {
            if (count >= thresholds.red) return '#ef4444';     // red-500
            if (count >= thresholds.orange) return '#f97316';  // orange-500
            if (count >= thresholds.yellow) return '#f59e0b';  // amber-500
            if (count > 0) return '#eab308';                   // yellow-500
            return '#22c55e';                                  // green-500
        }

        // --- Dashboard Generation ---
        function generateDashboard(pwsId) {
            function parseDate(dateString) { if (!dateString || typeof dateString !== 'string') return null; const d = new Date(dateString.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2')); return isNaN(d) ? null : d; }

            const systemInfo = DATA_STORE['SDWA_PUB_WATER_SYSTEMS.csv'].find(s => s.PWSID === pwsId);
            $('#dashboard-title').text(systemInfo?.PWS_NAME || 'Water System Dashboard');
            $('#dashboard-subtitle').text(`Serving ${systemInfo?.PRINCIPAL_CITY_SERVED_NAME || 'N/A'} | PWSID: ${pwsId}`);

            const violations = DATA_STORE["SDWA_VIOLATIONS_ENFORCEMENT.csv"].filter(v => v.PWSID === pwsId);

            // REVERTED: Using original field names from user's first code version
            const ganttData = violations.map(v => {
                const startDate = parseDate(v.NON_COMPL_PER_BEGIN_DATE);
                const finishDate = parseDate(v.RTC_DATE) || parseDate(v.NON_COMPL_PER_END_DATE) || new Date();
                const contaminant = CODES_MAP.get(`CONTAMINANT_CODE|${v.CONTAMINANT_CODE}`) || v.VIOLAT