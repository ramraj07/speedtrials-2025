<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWS Violations Dashboard</title>

    <!-- Framework and Library CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


    <!-- Custom Styling -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .chart-container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #dashboard-area { display: none; }
        .list-group-item {
            font-size: 0.9rem;
        }
        .list-group-item .badge {
            font-size: 0.9rem;
        }
        .select2-container--default .select2-selection--multiple {
             border: 1px solid #ced4da;
             border-radius: 0.25rem;
        }
    </style>
</head>
<body>

    <!-- Loading Indicator -->
    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-3">Loading and processing national data...</p>
    </div>

    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Public Water System (PWS) Dashboard</h1>

        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h5 class="chart-title">1. Find Your Water System</h5>
                    <div class="form-group">
                        <label for="zip-input">Filter by ZIP Code:</label>
                        <input type="text" id="zip-input" class="form-control" placeholder="Enter a 5-digit ZIP code">
                    </div>

                    <div class="form-group">
                        <label for="pws-select">Select Water System(s):</label>
                        <select id="pws-select" class="form-control" multiple="multiple" style="width: 100%;"></select>
                    </div>

                    <button id="filter-button" class="btn btn-primary btn-block">Generate Dashboard</button>
                    <hr>

                    <div id="initial-info">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-center">Top 5 Cleanest ZIPs</h6>
                                <p class="text-center text-muted" style="font-size:0.8rem">(Fewest Violations)</p>
                                <ul id="cleanest-zips" class="list-group"></ul>
                            </div>
                            <div class="col-6">
                                <h6 class="text-center">Top 5 Worst ZIPs</h6>
                                <p class="text-center text-muted" style="font-size:0.8rem">(Most Violations)</p>
                                <ul id="worst-zips" class="list-group"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Dashboard -->
            <div class="col-md-8">
                <div id="dashboard-area">
                    <h3 id="dashboard-title" class="text-center mb-4"></h3>
                    <!-- Gantt Chart -->
                    <div class="chart-container">
                        <div class="chart-title">Violation Timeline</div>
                        <div id="gantt-chart"></div>
                    </div>
                    <!-- Pie Chart -->
                    <div class="chart-container">
                        <div class="chart-title">Violation Types</div>
                        <div id="pie-chart"></div>
                    </div>
                    <!-- Site Visits Table -->
                     <div class="chart-container">
                        <div class="chart-title">Site Visits</div>
                        <div id="site-visits-table-container">
                             <table class="table table-striped table-bordered table-hover" id="site-visits-table">
                                <thead><tr><th>Visit Date</th><th>Reason</th><th>Agency Type</th><th>Comments</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Facilities Table -->
                    <div class="chart-container">
                        <div class="chart-title">Source Facilities</div>
                         <div id="facilities-table-container">
                             <table class="table table-striped table-bordered table-hover" id="facilities-table">
                                <thead><tr><th>Facility Name</th><th>Type</th><th>Water Type</th><th>Availability</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                 <div id="dashboard-placeholder" class="chart-container text-center">
                    <h4>Please select one or more water systems and click "Generate Dashboard" to begin.</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.5.4/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    $(document).ready(function() {
        // --- DATA GLOBALS ---
        let DATA_STORE = {};
        let PWS_OPTIONS = [];
        let ZIP_TO_PWS_MAP = new Map();

        // --- DATA LOADING ---
        const filesToLoad = [
            "SDWA_VIOLATIONS_ENFORCEMENT.csv", "SDWA_PUB_WATER_SYSTEMS.csv",
            "SDWA_GEOGRAPHIC_AREAS.csv", "SDWA_REF_CODE_VALUES.csv",
            "SDWA_SITE_VISITS.csv", "SDWA_FACILITIES.csv"
        ];
        const promises = filesToLoad.map(file => new Promise((resolve, reject) => {
            Papa.parse(file, {
                download: true, header: true, skipEmptyLines: true,
                complete: results => resolve({ name: file, data: results.data }),
                error: err => reject(err)
            });
        }));

        Promise.all(promises).then(files => {
            files.forEach(file => { DATA_STORE[file.name] = file.data; });
            prepareInitialData();
            $('#loader').fadeOut();
        }).catch(err => {
            console.error("Error loading CSV files:", err);
            $('#loader').html('<p style="color:red;">Failed to load data files. Please check console.</p>');
        });

        function prepareInitialData() {
            // --- Build PWS options for dropdown ---
            const systemsMap = new Map(DATA_STORE["SDWA_PUB_WATER_SYSTEMS.csv"].map(d => [d.PWSID, d]));
            PWS_OPTIONS = [...systemsMap.values()]
                .filter(s => s.PWS_NAME)
                .map(s => ({ id: s.PWSID, text: `${s.PWS_NAME} (${s.PWSID})` }))
                .sort((a, b) => a.text.localeCompare(b.text));

            $('#pws-select').select2({ data: PWS_OPTIONS, placeholder: 'Select system(s)' });

            // --- Build ZIP to PWS mapping ---
            DATA_STORE["SDWA_GEOGRAPHIC_AREAS.csv"].forEach(d => {
                if (d.AREA_TYPE_CODE === 'ZC' && d.ZIP_CODE_SERVED) {
                    const zip = d.ZIP_CODE_SERVED.trim().substring(0, 5);
                    if (!ZIP_TO_PWS_MAP.has(zip)) {
                        ZIP_TO_PWS_MAP.set(zip, new Set());
                    }
                    ZIP_TO_PWS_MAP.get(zip).add(d.PWSID);
                }
            });

            // --- Calculate and Display Top/Worst ZIPs ---
            const zipViolationCounts = new Map();
            DATA_STORE["SDWA_VIOLATIONS_ENFORCEMENT.csv"].forEach(v => {
                // Find all zips for this PWSID
                const zipsForPws = [...ZIP_TO_PWS_MAP.entries()]
                    .filter(([zip, pwsids]) => pwsids.has(v.PWSID))
                    .map(([zip, pwsids]) => zip);

                zipsForPws.forEach(zip => {
                    zipViolationCounts.set(zip, (zipViolationCounts.get(zip) || 0) + 1);
                });
            });

            const sortedZips = [...zipViolationCounts.entries()].sort((a, b) => a[1] - b[1]);
            const cleanest = sortedZips.slice(0, 5);
            const worst = sortedZips.slice(-5).reverse();

            cleanest.forEach(([zip, count]) => $('#cleanest-zips').append(`<li class="list-group-item d-flex justify-content-between align-items-center">${zip}<span class="badge badge-success badge-pill">${count}</span></li>`));
            worst.forEach(([zip, count]) => $('#worst-zips').append(`<li class="list-group-item d-flex justify-content-between align-items-center">${zip}<span class="badge badge-danger badge-pill">${count}</span></li>`));
        }

        // --- EVENT HANDLERS ---
        $('#zip-input').on('keyup', function() {
            const zip = $(this).val().trim();
            if (zip.length === 5 && ZIP_TO_PWS_MAP.has(zip)) {
                const pwsidsInZip = [...ZIP_TO_PWS_MAP.get(zip)];
                const filteredOptions = PWS_OPTIONS.filter(opt => pwsidsInZip.includes(opt.id));
                $('#pws-select').empty().select2({ data: filteredOptions, placeholder: 'Select system(s) from ZIP' });
            } else if(zip.length === 0) {
                 $('#pws-select').empty().select2({ data: PWS_OPTIONS, placeholder: 'Select system(s)' });
            }
        });

        $('#filter-button').on('click', function() {
            const selectedPWSIDs = $('#pws-select').val();
            if (!selectedPWSIDs || selectedPWSIDs.length === 0) {
                alert("Please select at least one water system.");
                return;
            }
            $('#initial-info').hide();
            $('#dashboard-placeholder').hide();
            $('#dashboard-area').show();
            generateDashboard(selectedPWSIDs);
        });

        // --- DASHBOARD GENERATION ---
        function generateDashboard(pwsIDs) {
            const systemNames = pwsIDs.map(id => DATA_STORE['SDWA_PUB_WATER_SYSTEMS.csv'].find(s => s.PWSID === id)?.PWS_NAME || id).join(', ');
            $('#dashboard-title').text(`Dashboard for: ${systemNames}`);

            // Filter main data sources
            const violations = DATA_STORE["SDWA_VIOLATIONS_ENFORCEMENT.csv"].filter(v => pwsIDs.includes(v.PWSID));
            const siteVisits = DATA_STORE["SDWA_SITE_VISITS.csv"].filter(v => pwsIDs.includes(v.PWSID));
            const facilities = DATA_STORE["SDWA_FACILITIES.csv"].filter(f => pwsIDs.includes(f.PWSID) && f.IS_SOURCE_IND === 'Y');
            const codesMap = new Map(DATA_STORE["SDWA_REF_CODE_VALUES.csv"].map(d => [`${d.VALUE_TYPE}|${d.VALUE_CODE}`, d.VALUE_DESCRIPTION]));

            // --- Gantt Chart ---
            const ganttData = violations.map(v => ({
                Task: codesMap.get(`CONTAMINANT_CODE|${v.CONTAMINANT_CODE}`) || v.CONTAMINANT_CODE,
                Start: v.NON_COMPL_PER_BEGIN_DATE,
                Finish: v.NON_COMPL_PER_END_DATE || new Date().toISOString().split('T')[0], // Use today for ongoing
                Resource: v.IS_HEALTH_BASED_IND === 'Y' ? 'Health-Based' : 'Non-Health-Based'
            })).filter(d => d.Start);

            if (ganttData.length > 0) {
                const colors = {'Health-Based': 'rgb(217, 83, 79)', 'Non-Health-Based': 'rgb(240, 173, 78)'};
                const fig = ff.create_gantt(ganttData, colors=colors, index_col='Resource', show_colorbar=true, group_tasks=true);
                Plotly.newPlot('gantt-chart', fig);
            } else {
                 $('#gantt-chart').html('<p class="text-center">No violation data to display.</p>');
            }

            // --- DC.js Pie Chart ---
            const ndx = crossfilter(violations);
            const violationTypeDim = ndx.dimension(d => codesMap.get(`VIOLATION_CODE|${d.VIOLATION_CODE}`) || d.VIOLATION_CODE);
            const violationTypeGroup = violationTypeDim.group().reduceCount();

            dc.pieChart('#pie-chart')
                .width(null).height(300)
                .dimension(violationTypeDim)
                .group(violationTypeGroup)
                .legend(dc.legend());
            dc.renderAll();

            // --- Site Visits Table ---
            const visitsTbody = $('#site-visits-table tbody').empty();
            if (siteVisits.length > 0) {
                siteVisits.forEach(v => {
                    const reason = codesMap.get(`VISIT_REASON_CODE|${v.VISIT_REASON_CODE}`) || v.VISIT_REASON_CODE;
                    const agency = codesMap.get(`AGENCY_TYPE_CODE|${v.AGENCY_TYPE_CODE}`) || v.AGENCY_TYPE_CODE;
                    visitsTbody.append(`<tr><td>${v.VISIT_DATE}</td><td>${reason}</td><td>${agency}</td><td>${v.VISIT_COMMENTS || ''}</td></tr>`);
                });
            } else {
                visitsTbody.append('<tr><td colspan="4" class="text-center">No site visits found.</td></tr>');
            }

            // --- Facilities Table ---
            const facilitiesTbody = $('#facilities-table tbody').empty();
             if (facilities.length > 0) {
                facilities.forEach(f => {
                     const facType = codesMap.get(`FACILITY_TYPE_CODE|${f.FACILITY_TYPE_CODE}`) || f.FACILITY_TYPE_CODE;
                     const waterType = codesMap.get(`WATER_TYPE_CODE|${f.WATER_TYPE_CODE}`) || f.WATER_TYPE_CODE;
                     const availability = codesMap.get(`AVAILABILITY_CODE|${f.AVAILABILITY_CODE}`) || f.AVAILABILITY_CODE;
                    facilitiesTbody.append(`<tr><td>${f.FACILITY_NAME}</td><td>${facType}</td><td>${waterType}</td><td>${availability}</td></tr>`);
                });
            } else {
                facilitiesTbody.append('<tr><td colspan="4" class="text-center">No source facilities found.</td></tr>');
            }
        }
    });
    </script>
</body>
</html>
