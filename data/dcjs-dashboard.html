<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive SDWIS Dashboard</title>

    <!-- Framework and Library CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.min.css">

    <!-- Custom Styling -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
        }
        .chart-container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        .chart-title a {
            font-size: 0.8rem;
            margin-left: 10px;
            vertical-align: middle;
        }
        #data-count {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        #loader p {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #555;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dc-chart g.row text {
            fill: #333;
        }
    </style>
</head>
<body>

    <!-- Loading Indicator -->
    <div id="loader">
        <div class="spinner"></div>
        <p>Loading and processing data... Please wait.</p>
    </div>

    <div class="container-fluid">
        <h1 class="text-center mb-4">Georgia Drinking Water Violations Dashboard</h1>

        <!-- Control Row with Data Count and PWS Dropdown -->
        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <div id="data-count">
                    <span class="filter-count"></span> selected out of <span class="total-count"></span> records |
                    <a href="javascript:dc.filterAll(); dc.renderAll(); $('#pws-select').val('');">Reset All Filters</a>
                </div>
            </div>
            <div class="col-md-4">
                 <select id="pws-select" class="form-control" title="Filter by Water System"></select>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">Violations by County
                        <a href="javascript:dc.filterAll(); dc.renderAll();" class="reset" style="display: none;">reset</a>
                    </div>
                    <div id="county-chart"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="chart-container">
                    <div class="chart-title">Violations by System Type
                        <a href="javascript:dc.filterAll(); dc.renderAll();" class="reset" style="display: none;">reset</a>
                    </div>
                    <div id="system-type-chart"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="chart-container">
                    <div class="chart-title">Health-Based Violations
                        <a href="javascript:dc.filterAll(); dc.renderAll();" class="reset" style="display: none;">reset</a>
                    </div>
                    <div id="health-based-chart"></div>
                </div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <div class="chart-title">Violations Over Time
                        <a href="javascript:dc.filterAll(); dc.renderAll();" class="reset" style="display: none;">reset</a>
                    </div>
                    <div id="timeline-chart"></div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <div class="chart-title">Filtered Violation Records</div>
                    <table class="table table-striped table-bordered table-hover" id="data-table">
                        <thead>
                            <tr>
                                <th>System Name</th>
                                <th>County</th>
                                <th>Contaminant</th>
                                <th>Violation Date</th>
                                <th>Violation Type</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.5.4/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
    $(document).ready(function() {
        // --- DATA LOADING ---
        const filesToLoad = [
            "SDWA_VIOLATIONS_ENFORCEMENT.csv", // Main data file
            "SDWA_PUB_WATER_SYSTEMS.csv",      // Lookup for system info
            "SDWA_GEOGRAPHIC_AREAS.csv",       // Lookup for county info
            "SDWA_REF_CODE_VALUES.csv"         // Lookup for descriptions
        ];

        const promises = filesToLoad.map(file => {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: results => resolve({ name: file, data: results.data }),
                    error: err => reject(err)
                });
            });
        });

        Promise.all(promises).then(files => {
            const dataStore = {};
            files.forEach(file => {
                dataStore[file.name] = file.data;
            });
            initializeDashboard(dataStore);
        }).catch(err => {
            console.error("Error loading CSV files:", err);
            $('#loader').html('<p style="color:red;">Failed to load data files. Please check the browser console for errors.</p>');
        });

        function initializeDashboard(data) {
            console.log("Data loaded, processing and creating dashboard...");

            // --- DATA PREPARATION AND ENRICHMENT ---
            const violations = data["SDWA_VIOLATIONS_ENFORCEMENT.csv"];
            const systemsMap = new Map(data["SDWA_PUB_WATER_SYSTEMS.csv"].map(d => [d.PWSID, d]));
            const geoMap = new Map();
            data["SDWA_GEOGRAPHIC_AREAS.csv"].forEach(d => {
                if(d.AREA_TYPE_CODE === 'CN') {
                    geoMap.set(d.PWSID, d.COUNTY_SERVED);
                }
            });
            const codesMap = new Map(data["SDWA_REF_CODE_VALUES.csv"].map(d => [`${d.VALUE_TYPE}|${d.VALUE_CODE}`, d.VALUE_DESCRIPTION]));

            violations.forEach(v => {
                const system = systemsMap.get(v.PWSID);
                if (system) {
                    v.PWS_NAME = system.PWS_NAME;
                    v.PWS_TYPE_CODE = system.PWS_TYPE_CODE;
                } else {
                    v.PWS_NAME = "Unknown System";
                    v.PWS_TYPE_CODE = "Unknown";
                }
                v.COUNTY_SERVED = geoMap.get(v.PWSID) || "Unknown County";
                v.CONTAMINANT_NAME = codesMap.get(`CONTAMINANT_CODE|${v.CONTAMINANT_CODE}`) || v.CONTAMINANT_CODE;
                v.VIOLATION_NAME = codesMap.get(`VIOLATION_CODE|${v.VIOLATION_CODE}`) || v.VIOLATION_CODE;
                v.date = d3.timeParse("%m/%d/%Y")(v.NON_COMPL_PER_BEGIN_DATE);
            });

            const cleanViolations = violations.filter(v => v.date);

            // --- POPULATE PWS DROPDOWN ---
            const pwsSelect = $('#pws-select');
            pwsSelect.append('<option value="">All Water Systems</option>');
            const sortedSystems = [...systemsMap.values()]
                .filter(s => s.PWS_NAME) // Ensure system has a name
                .sort((a, b) => a.PWS_NAME.localeCompare(b.PWS_NAME));
            sortedSystems.forEach(system => {
                pwsSelect.append(`<option value="${system.PWSID}">${system.PWS_NAME} (${system.PWSID})</option>`);
            });

            // --- CROSSFILTER SETUP ---
            const ndx = crossfilter(cleanViolations);

            // --- DIMENSIONS ---
            const pwsIdDim = ndx.dimension(d => d.PWSID); // New dimension for dropdown
            const countyDim = ndx.dimension(d => d.COUNTY_SERVED);
            const systemTypeDim = ndx.dimension(d => d.PWS_TYPE_CODE);
            const healthBasedDim = ndx.dimension(d => d.IS_HEALTH_BASED_IND === 'Y' ? 'Yes' : 'No');
            const timeDim = ndx.dimension(d => d.date);
            const tableDim = ndx.dimension(d => d.date);

            // --- GROUPS ---
            const countyGroup = countyDim.group().reduceCount();
            const systemTypeGroup = systemTypeDim.group().reduceCount();
            const healthBasedGroup = healthBasedDim.group().reduceCount();
            const timeGroup = timeDim.group(d3.timeMonth).reduceCount();

            // --- CHART DEFINITIONS ---

            // County Chart (Row Chart)
            const countyChart = dc.rowChart('#county-chart');
            countyChart
                .width(null)
                .height(400)
                .margins({ top: 10, right: 10, bottom: 20, left: 10 })
                .dimension(countyDim)
                .group(countyGroup)
                .elasticX(true)
                .cap(15)
                .othersLabel("Other Counties");

            // System Type Chart (Pie Chart)
            const systemTypeChart = dc.pieChart('#system-type-chart');
            systemTypeChart
                .width(null)
                .height(400)
                .dimension(systemTypeDim)
                .group(systemTypeGroup)
                .innerRadius(50)
                .legend(dc.legend());

            // Health Based Chart (Pie Chart)
            const healthBasedChart = dc.pieChart('#health-based-chart');
            healthBasedChart
                .width(null)
                .height(400)
                .dimension(healthBasedDim)
                .group(healthBasedGroup)
                .legend(dc.legend());

            // Timeline Chart (Bar Chart)
            const timelineChart = dc.barChart('#timeline-chart');
            timelineChart
                .width(null)
                .height(250)
                .margins({top: 10, right: 50, bottom: 30, left: 40})
                .dimension(timeDim)
                .group(timeGroup)
                .x(d3.scaleTime().domain([d3.min(cleanViolations, d => d.date), d3.max(cleanViolations, d => d.date)]))
                .round(d3.timeMonth.round)
                .xUnits(d3.timeMonths)
                .elasticY(true)
                .renderHorizontalGridLines(true);

            // Data Count
            const dataCount = dc.dataCount('#data-count');
            dataCount
                .crossfilter(ndx)
                .groupAll(ndx.groupAll());

            // Data Table
            const dataTable = dc.dataTable('#data-table');
            dataTable
                .dimension(tableDim)
                .size(100)
                .columns([
                    'PWS_NAME',
                    'COUNTY_SERVED',
                    'CONTAMINANT_NAME',
                    {
                        label: 'Violation Date',
                        format: d => d3.timeFormat('%Y-%m-%d')(d.date)
                    },
                    'VIOLATION_NAME'
                ])
                .sortBy(d => d.date)
                .order(d3.descending);

            // --- EVENT LISTENERS ---
            pwsSelect.on('change', function() {
                const selectedPwsid = $(this).val();
                if (selectedPwsid) {
                    pwsIdDim.filter(selectedPwsid);
                } else {
                    pwsIdDim.filter(null); // Clear the filter
                }
                dc.renderAll();
            });

            // --- RENDER ---
            dc.renderAll();

            // Hide loader and show content
            $('#loader').fadeOut();
        }
    });
    </script>
</body>
</html>
