<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Drinking Water Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">

    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #3498db;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }
        .chart-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary-color);
        }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid var(--secondary-color);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #dashboard-page { display: none; }
        #landing-page {
            min-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .landing-box {
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        .landing-box h1 { color: var(--primary-color); font-weight: 700; margin-bottom: 15px; }
        .landing-box p { font-size: 1.1rem; color: #6c757d; margin-bottom: 30px; }
        .list-group-item.browse-item { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .list-group-item.browse-item:hover { background-color: var(--light-gray); }
        .list-group-item .badge { font-size: 0.9rem; }
        .select2-container--bootstrap .select2-selection--single { height: calc(1.5em + .75rem + 2px); }
        #back-to-search { position: absolute; top: 20px; left: 20px; z-index: 100; }
        #dashboard-header { margin-top: 60px; }

        #gantt-chart-scroll-wrapper {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p class="mt-3 font-weight-bold">Loading Georgia Water System Data...</p></div>
    <div id="landing-page" class="container"><div class="landing-box"><h1>Georgia Water Quality Explorer</h1><p>Enter a ZIP code, city, or water system name to find your local water quality report.</p><div class="form-group"><select id="pws-select" class="form-control" style="width: 100%;"></select></div><hr class="my-4"><div class="row"><div class="col-md-6"><h6 class="text-success">Top 5 Cleanest Systems</h6><p class="text-muted" style="font-size:0.8rem;">(Fewest violations in the last 5 years)</p><ul id="cleanest-pws" class="list-group list-group-flush"></ul></div><div class="col-md-6"><h6 class="text-danger">Top 5 Systems with Most Violations</h6><p class="text-muted" style="font-size:0.8rem;">(Most violations in the last 5 years)</p><ul id="worst-pws" class="list-group list-group-flush"></ul></div></div></div></div>
    <div id="dashboard-page" class="container-fluid mt-4">
        <button id="back-to-search" class="btn btn-outline-primary">&larr; Back to Search</button>
        <div id="dashboard-header" class="text-center mb-4"><h2 id="dashboard-title"></h2><p id="dashboard-subtitle" class="lead text-muted"></p></div>
        <div class="row"><div class="col-12"><div id="gantt-chart-container" class="chart-container" style="display: none;"><div class="chart-title">Violation Timeline</div><p class="text-center text-muted small mt-n3 mb-3">Timeline of health-based and other violations. If the list is long, scroll within the chart area to see all entries.</p><div id="gantt-chart-scroll-wrapper"><div id="gantt-chart"></div></div></div></div></div>
        <div class="row"><div class="col-lg-12"><div class="chart-container"><div class="chart-title">Recent Site Visits</div><div id="site-visits-table-container" class="table-responsive"><table class="table table-striped table-bordered table-hover" id="site-visits-table"><thead><tr><th>Visit Date</th><th>Reason</th><th>Agency</th><th>Comments</th></tr></thead><tbody></tbody></table></div></div></div><div class="col-lg-12"><div class="chart-container"><div class="chart-title">Water Source Facilities</div><div id="facilities-table-container" class="table-responsive"><table class="table table-striped table-bordered table-hover" id="facilities-table"><thead><tr><th>Facility Name</th><th>Type</th><th>Water Type</th><th>Availability</th></tr></thead><tbody></tbody></table></div></div></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    $(document).ready(function() {
        // All previous setup code remains the same
        let DATA_STORE = {}; let PWS_SEARCH_OPTIONS = []; let CODES_MAP = new Map();
        const $loader = $('#loader'); const $landingPage = $('#landing-page'); const $dashboardPage = $('#dashboard-page');
        const filesToLoad = ["SDWA_VIOLATIONS_ENFORCEMENT.csv", "SDWA_PUB_WATER_SYSTEMS.csv", "SDWA_GEOGRAPHIC_AREAS.csv", "SDWA_REF_CODE_VALUES.csv", "SDWA_SITE_VISITS.csv", "SDWA_FACILITIES.csv"];
        const promises = filesToLoad.map(file => new Promise((resolve, reject) => { Papa.parse(file, { download: true, header: true, skipEmptyLines: true, complete: results => resolve({ name: file, data: results.data }), error: err => reject(err) }); }));
        Promise.all(promises).then(files => { files.forEach(file => { DATA_STORE[file.name] = file.data; }); prepareInitialData(); $loader.fadeOut(); }).catch(err => { console.error("Error loading or processing data:", err); $loader.html('<p style="color:red;">Failed to load data files. This application cannot run. Please check the browser console for more details.</p>'); });
        function prepareInitialData() { DATA_STORE["SDWA_REF_CODE_VALUES.csv"].forEach(d => { CODES_MAP.set(`${d.VALUE_TYPE}|${d.VALUE_CODE}`, d.VALUE_DESCRIPTION); }); const systems = new Map(DATA_STORE["SDWA_PUB_WATER_SYSTEMS.csv"].map(d => [d.PWSID, d])); const geo = DATA_STORE["SDWA_GEOGRAPHIC_AREAS.csv"]; PWS_SEARCH_OPTIONS = [...systems.values()].filter(s => s.PWS_NAME && s.PWS_ACTIVITY_CODE === 'A').map(s => { const zips = new Set(geo.filter(g => g.PWSID === s.PWSID && g.AREA_TYPE_CODE === 'ZC').map(g => g.ZIP_CODE_SERVED)); const searchTerms = [ (s.PWS_NAME || '').toLowerCase(), (s.PWSID || '').toLowerCase(), (s.PRINCIPAL_CITY_SERVED_NAME || '').toLowerCase(), ...[...zips].map(zip => (zip || '').toLowerCase()) ].join(' '); return { id: s.PWSID, text: `${s.PWS_NAME} (${s.PWSID})`, searchTerms: searchTerms }; }); $('#pws-select').select2({ data: PWS_SEARCH_OPTIONS, placeholder: 'Enter ZIP, City, or System Name...', theme: "bootstrap", matcher: (params, data) => { if ($.trim(params.term) === '') return data; if (typeof data.searchTerms === 'undefined') return null; if (data.searchTerms.indexOf(params.term.toLowerCase()) > -1) { return data; } return null; } }).on('select2:select', function (e) { const pwsId = e.params.data.id; if (pwsId) { showDashboard([pwsId]); } }); const violationCounts = new Map(); const fiveYearsAgo = new Date(); fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5); DATA_STORE["SDWA_VIOLATIONS_ENFORCEMENT.csv"].forEach(v => { const violationDate = new Date(v.NON_COMPL_PER_BEGIN_DATE); if (violationDate >= fiveYearsAgo) { const currentCount = violationCounts.get(v.PWSID) || 0; violationCounts.set(v.PWSID, currentCount + 1); } }); const allPwsIds = new Set([...systems.keys()]); allPwsIds.forEach(pwsid => { if (!violationCounts.has(pwsid)) { violationCounts.set(pwsid, 0); } }); const sortedPws = [...violationCounts.entries()].map(([pwsid, count]) => ({ pwsid, count, name: systems.get(pwsid)?.PWS_NAME, city: systems.get(pwsid)?.PRINCIPAL_CITY_SERVED_NAME })).filter(p => p.name).sort((a, b) => a.count - b.count); const cleanest = sortedPws.slice(0, 5); const worst = sortedPws.slice(-5).reverse(); cleanest.forEach(p => $('#cleanest-pws').append(`<li class="list-group-item browse-item d-flex justify-content-between align-items-center" data-pwsid="${p.pwsid}">${p.name}<span class="badge badge-success badge-pill">${p.count}</span></li>`)); worst.forEach(p => $('#worst-pws').append(`<li class="list-group-item browse-item d-flex justify-content-between align-items-center" data-pwsid="${p.pwsid}">${p.name}<span class="badge badge-danger badge-pill">${p.count}</span></li>`)); }
        function showDashboard(pwsIDs) { $landingPage.fadeOut('fast', () => { window.scrollTo(0, 0); generateDashboard(pwsIDs); $dashboardPage.fadeIn('fast', function() { const ganttChart = document.getElementById('gantt-chart'); if (ganttChart && ganttChart.data) { Plotly.Plots.resize(ganttChart); } }); }); }
        $('#back-to-search').on('click', function() { $dashboardPage.fadeOut('fast', () => { $('#pws-select').val(null).trigger('change'); $landingPage.fadeIn('fast'); }); });
        $('#landing-page').on('click', '.browse-item', function() { const pwsId = $(this).data('pwsid'); if (pwsId) { showDashboard([pwsId]); } });

        function generateDashboard(pwsIDs) {
            function parseDate(dateString) { if (!dateString || typeof dateString !== 'string') return null; if (dateString.includes('-')) { const d = new Date(dateString); return isNaN(d) ? null : d; } const parts = dateString.split('/'); if (parts.length === 3) { const year = parseInt(parts[2], 10); const month = parseInt(parts[0], 10) - 1; const day = parseInt(parts[1], 10); const dt = new Date(year, month, day); if (!isNaN(dt) && dt.getFullYear() === year && dt.getMonth() === month && dt.getDate() === day) { return dt; } } return null; }
            const systemsData = DATA_STORE['SDWA_PUB_WATER_SYSTEMS.csv'];
            const systemInfo = systemsData.find(s => s.PWSID === pwsIDs[0]);
            $('#dashboard-title').text(systemInfo?.PWS_NAME || 'Water System Dashboard');
            $('#dashboard-subtitle').text(`Serving ${systemInfo?.PRINCIPAL_CITY_SERVED_NAME || 'N/A'} | PWSID: ${pwsIDs[0]}`);
            const violations = DATA_STORE["SDWA_VIOLATIONS_ENFORCEMENT.csv"].filter(v => pwsIDs.includes(v.PWSID));

            const ganttData = violations.map(v => {
                const startDate = parseDate(v.NON_COMPL_PER_BEGIN_DATE);
                const finishDate = parseDate(v.RTC_DATE) || parseDate(v.NON_COMPL_PER_END_DATE) || new Date();
                const contaminant = CODES_MAP.get(`CONTAMINANT_CODE|${v.CONTAMINANT_CODE}`) || v.VIOLATION_CODE || 'Unknown Violation';
                if (startDate && finishDate && startDate < finishDate) {
                    return {
                        Task: contaminant.length > 50 ? contaminant.substring(0, 47) + '...' : contaminant,
                        FullTask: contaminant,
                        Start: startDate.toISOString().split('T')[0],
                        Finish: finishDate.toISOString().split('T')[0],
                        Resource: v.IS_HEALTH_BASED_IND === 'Y' ? 'Health-Based' : 'Non-Health-Based',
                        Details: CODES_MAP.get(`VIOLATION_CODE|${v.VIOLATION_CODE}`) || 'No details',
                        // *** THIS IS THE FIX ***
                        // Use the correct column names from the CSV file.
                        measuredValue: v.RESULT,
                        limitValue: v.MCL_VALUE,
                        unit: v.UNIT_OF_MEASURE
                    };
                }
                return null;
            }).filter(Boolean);

            if (ganttData.length > 0) {
                $('#gantt-chart-container').show();

                const plotData = [];
                ganttData.forEach(d => {
                    // Rebuild the tooltip text with the corrected data fields.
                    let tooltipText = `<b>${d.FullTask}</b><br>Type: ${d.Details}<br>Period: ${d.Start} to ${d.Finish}<br>Classification: ${d.Resource}`;
                    if (d.measuredValue && d.limitValue) {
                        tooltipText += `<br><br><b>Result: ${d.measuredValue} ${d.unit || ''}</b><br>Limit: ${d.limitValue} ${d.unit || ''}`;
                    }

                    plotData.push({
                        x: [d.Start, d.Finish], y: [d.Task, d.Task],
                        mode: 'lines', type: 'scatter', showlegend: false,
                        line: { color: '#333333', width: 22 },
                        hoverinfo: 'skip'
                    });
                    plotData.push({
                        x: [d.Start, d.Finish], y: [d.Task, d.Task],
                        mode: 'lines', type: 'scatter', showlegend: false,
                        line: { color: d.Resource === 'Health-Based' ? 'rgba(217, 83, 79, 0.9)' : 'rgba(240, 173, 78, 0.9)', width: 20 },
                        hoverinfo: 'text',
                        text: tooltipText
                    });
                });

                plotData.push({ x: [null], y: [null], mode: 'markers', name: 'Health-Based', marker: { color: 'rgba(217, 83, 79, 1)', size: 10 } });
                plotData.push({ x: [null], y: [null], mode: 'markers', name: 'Non-Health-Based', marker: { color: 'rgba(240, 173, 78, 1)', size: 10 } });

                const presentDay = new Date().toISOString().split('T')[0];
                const layout = {
                    autosize: true,
                    xaxis: { type: 'date', title: 'Date of Violation Period', range: ['2021-01-01', presentDay], rangeselector: {buttons: [{count: 1, label: '1y', step: 'year', stepmode: 'backward'},{count: 3, label: '3y', step: 'year', stepmode: 'backward'},{count: 5, label: '5y', step: 'year', stepmode: 'backward'},{step: 'all'}]},
                        rangeslider: { thickness: 0.1 },
                    },
                    yaxis: { automargin: true, autorange: 'reversed' },
                    hovermode: 'closest', showlegend: true,
                    legend: { x: 1, xanchor: 'right', y: 1 },
                    margin: { l: 300, t: 50, b: 50 }
                };
                Plotly.newPlot('gantt-chart', plotData, layout, {responsive: true});
            } else {
                 $('#gantt-chart-container').hide();
                 Plotly.purge('gantt-chart');
            }

            const siteVisits = DATA_STORE["SDWA_SITE_VISITS.csv"].filter(v => pwsIDs.includes(v.PWSID)).sort((a,b) => new Date(b.VISIT_DATE) - new Date(a.VISIT_DATE));
            const facilities = DATA_STORE["SDWA_FACILITIES.csv"].filter(f => pwsIDs.includes(f.PWSID) && f.IS_SOURCE_IND === 'Y');
            const visitsTbody = $('#site-visits-table tbody').empty();
            if (siteVisits.length > 0) {
                siteVisits.slice(0, 20).forEach(v => { const reason = CODES_MAP.get(`VISIT_REASON_CODE|${v.VISIT_REASON_CODE}`) || v.VISIT_REASON_CODE; const agency = CODES_MAP.get(`AGENCY_TYPE_CODE|${v.AGENCY_TYPE_CODE}`) || v.AGENCY_TYPE_CODE; visitsTbody.append(`<tr><td>${v.VISIT_DATE}</td><td>${reason}</td><td>${agency}</td><td>${v.VISIT_COMMENTS || ''}</td></tr>`); });
            } else { visitsTbody.append('<tr><td colspan="4" class="text-center">No site visits found.</td></tr>'); }
            const facilitiesTbody = $('#facilities-table tbody').empty();
            if (facilities.length > 0) {
                facilities.forEach(f => { const facType = CODES_MAP.get(`FACILITY_TYPE_CODE|${f.FACILITY_TYPE_CODE}`) || f.FACILITY_TYPE_CODE; const waterType = CODES_MAP.get(`WATER_TYPE_CODE|${f.WATER_TYPE_CODE}`) || f.WATER_TYPE_CODE; const availability = CODES_MAP.get(`AVAILABILITY_CODE|${f.AVAILABILITY_CODE}`) || f.AVAILABILITY_CODE; facilitiesTbody.append(`<tr><td>${f.FACILITY_NAME}</td><td>${facType}</td><td>${waterType}</td><td>${availability}</td></tr>`); });
            } else { facilitiesTbody.append('<tr><td colspan="4" class="text-center">No source facilities found.</td></tr>'); }
        }
    });
    </script>
</body>
</html>